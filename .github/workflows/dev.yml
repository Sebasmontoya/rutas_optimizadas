name: Code Development Flow
concurrency: ${{ github.event.repository.name }}-dev
on:
    push:
        branches:
            - 'dev'
env:
    SERVICE_NAME: ${{ github.event.repository.name }}
    PROJECT_CLUSTER_ID: ${{ secrets.PROJECT_CLUSTER_ID_DEV }}
    PROJECT_ID: ${{ secrets.PROJECT_ID_DEV }}
    CLUSTER_NAME: cm-cluster-dev-02
    CLUSTER_LOCATION: us-central1
    ENV_FILE: env/dev.env
    ENV: dev
    HOST: apiv2-dev.coordinadora.com
    DOMAIN: consolidacion

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest
        name: Build and deploy
        steps:
            - name: Checkout
              uses: actions/checkout@v2
            - name: Cache node modules
              uses: actions/cache@v2
              with:
                  path: '**/node_modules'
                  key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}
            - name: Install and Build
              uses: ./.github/actions/build
            - name: Build tests
              uses: ./.github/actions/quality
            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v0
              with:
                  project_id: ${{ env.PROJECT_CLUSTER_ID }}
                  service_account_key: ${{ secrets.CM_GCP_KEY }}
                  export_default_credentials: true
            - name: Env variable
              run: |
                  echo "GCP_PROJECT=${{env.PROJECT_ID}}" >> ${{ env.ENV_FILE }}
                  echo "SERVICE_NAME=${{env.SERVICE_NAME}}" >> ${{ env.ENV_FILE }}
                  echo "HOST=${{env.HOST}}" >> ${{ env.ENV_FILE }}
                  echo "DOMAIN=${{env.DOMAIN}}" >> ${{ env.ENV_FILE }}
            - name: Create ENV File
              run: cp ${{ env.ENV_FILE }} .env
            - name: Build and deploy image
              run: PROJECT_ID=$PROJECT_CLUSTER_ID COMMIT_SHA=${{ github.sha }} SERVICE_NAME=$SERVICE_NAME make deploy

    kubernetes:
        runs-on: ubuntu-latest
        name: Kubernetes
        needs: build_and_deploy
        steps:
            - name: Checkout
              uses: actions/checkout@v2
            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v0
              with:
                  project_id: ${{ env.PROJECT_CLUSTER_ID }}
                  service_account_key: ${{ secrets.CM_GCP_KEY }}
                  export_default_credentials: true
            - id: get-credentials
              name: Get Credentials
              uses: google-github-actions/get-gke-credentials@main
              with:
                  cluster_name: ${{ env.CLUSTER_NAME }}
                  location: ${{ env.CLUSTER_LOCATION }}
                  credentials: ${{ secrets.CM_GCP_KEY }}
                  project_id: ${{ env.PROJECT_CLUSTER_ID }}
                  service_name: ${{ env.SERVICE_NAME}}
                  domain: ${{ env.DOMAIN}}
            - name: Setup Kustomize
              uses: imranismail/setup-kustomize@v1
              with:
                  kustomize-version: '3.9.2'
            - name: Update image
              run: kustomize edit set image PROJECT/IMAGE=gcr.io/$PROJECT_CLUSTER_ID/$SERVICE_NAME:$GITHUB_SHA
              working-directory: ./manifests/overlays/${{ env.ENV }}
            - name: Build and Deploy
              run: HOST=$HOST SERVICE_NAME=$SERVICE_NAME GCP_PROJECT=$PROJECT_ID DOMAIN=$DOMAIN kustomize build . | envsubst | kubectl apply -f -
              working-directory: ./manifests/overlays//${{ env.ENV }}
            - name: Delete pods
              run: kubectl --namespace=apis delete pod -l app=$SERVICE_NAME
